!function(t){"use strict";t.subformRepeatable=function(e,o){if(this.$container=t(e),this.$container.data("subformRepeatable"))return r;this.$container.data("subformRepeatable",r),this.options=t.extend({},t.subformRepeatable.defaults,o),this.template="",this.prepareTemplate(),this.$containerRows=this.options.rowsContainer?this.$container.find(this.options.rowsContainer):this.$container;var r=this;this.$container.on("click",this.options.btAdd,function(e){e.preventDefault();var o=t(this).parents(r.options.repeatableElement);o.length||(o=null),r.addRow(o)}),this.$container.on("click",this.options.btRemove,function(e){e.preventDefault();var o=t(this).parents(r.options.repeatableElement);r.removeRow(o)}),this.options.btMove&&this.$containerRows.sortable({items:this.options.repeatableElement,handle:this.options.btMove,tolerance:"pointer"}),this.$container.trigger("subform-ready")},t.subformRepeatable.prototype.prepareTemplate=function(){if(this.options.rowTemplateSelector){var e=this.$container.find(this.options.rowTemplateSelector).last();this.template=t.trim(e.html())||"",this.$tmplElement=e}else{var o=this.$container.find(this.options.repeatableElement).get(0),r=t(o).clone();try{this.clearScripts(r)}catch(t){window.console&&console.log(t)}this.template=r.prop("outerHTML")}},t.subformRepeatable.prototype.addRow=function(e){var o=this.$containerRows.find(this.options.repeatableElement).length;if(o>=this.options.maximum)return null;var r=t.parseHTML(htmlspecialchar.decode(this.template));e?t(e).after(r):this.$containerRows.append(r);var a=t(r);a.attr("data-new","true"),this.fixUniqueAttributes(a,o);try{this.fixScripts(a)}catch(t){window.console&&console.log(t)}return this.$container.trigger("subform-row-add",a),a},t.subformRepeatable.prototype.removeRow=function(t){this.$containerRows.find(this.options.repeatableElement).length<=this.options.minimum||(this.$container.trigger("subform-row-remove",t),t.remove())},t.subformRepeatable.prototype.fixUniqueAttributes=function(e,o,r,a){var i=void 0===r?e.attr("data-group"):r,n=void 0===a?e.attr("data-base-name"):a,s=void 0===o?0:o,l=n+s;e.attr("data-group",l);for(var p=e.find("[name]"),c={},f=0,h=p.length;f<h;f++){var u=t(p[f]),m=u.attr("name"),d=m.replace(/(\[\]$)/g,"").replace(/(\]\[)/g,"__").replace(/\[/g,"_").replace(/\]/g,""),b=m.replace("["+i+"][","["+l+"]["),v=d.replace(i,l),w=0,g=d;"checkbox"===u.prop("type")&&m.match(/\[\]$/)?((w=c[d]?c[d].length:0)||(u.closest("fieldset.checkboxes").attr("id",v),e.find('label[for="'+d+'"]').attr("for",v).attr("id",v+"-lbl")),g+=w,v+=w):"radio"===u.prop("type")&&((w=c[d]?c[d].length:0)||(u.closest("fieldset.radio").attr("id",v),e.find('label[for="'+d+'"]').attr("for",v).attr("id",v+"-lbl")),g+=w,v+=w),c[d]?c[d].push(!0):c[d]=[!0],u.attr("name",b),u.attr("id",v),e.find('label[for="'+g+'"]').attr("for",v).attr("id",v+"-lbl")}for(var R=e.find(this.options.rowTemplateSelector),$=0;$<R.length;$++){var y=t(t(R[$]).prop("content"));this.fixUniqueAttributes(y,s,i,n)}},t.subformRepeatable.prototype.clearScripts=function(e){t.fn.chosen&&e.find("select.chzn-done").each(function(){var e=t(this);e.next(".chzn-container").remove(),e.show().addClass("fix-chosen")})},t.subformRepeatable.prototype.fixScripts=function(e){e.find('a[onclick*="jInsertFieldValue"]').each(function(){var e=t(this),o=e.siblings('input[type="text"]').attr("id"),r=e.prev(),a=r.attr("href");e.attr("onclick","jInsertFieldValue('', '"+o+"');return false;"),r.attr("href",a.replace(/&fieldid=(.+)&/,"&fieldid="+o+"&"))})},t.subformRepeatable.defaults={btAdd:".group-add",btRemove:".group-remove",btMove:".group-move",minimum:0,maximum:10,repeatableElement:".subform-repeatable-group",rowTemplateSelector:"template.subform-repeatable-template-section",rowsContainer:null},t.fn.subformRepeatable=function(e){return this.each(function(){var e=e||{},o=t(this).data();if(!o.subformRepeatable){for(var r in o)o.hasOwnProperty(r)&&(e[r]=o[r]);var a=new t.subformRepeatable(this,e);t(this).data("subformRepeatable",a)}})},t(function(t){function e(e,o){t(o||document).find("div.subform-repeatable").subformRepeatable()}e(),t(document).on("subform-row-add",e)}),window.htmlspecialchar={decode:function(t){var e={"&amp;":"&","&#038;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'","&#8217;":"’","&#8216;":"‘","&#8211;":"–","&#8212;":"—","&#8230;":"…","&#8221;":"”"};return t.replace(/\&[\w\d\#]{2,5}\;/g,function(t){return e[t]})}}}(jQuery);
