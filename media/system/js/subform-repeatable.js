!function(x){"use strict";x.subformRepeatable=function(e,t){if(this.$container=x(e),this.$container.data("subformRepeatable"))return r;this.$container.data("subformRepeatable",r),this.options=x.extend({},x.subformRepeatable.defaults,t),this.template="",this.prepareTemplate(),this.$containerRows=this.options.rowsContainer?this.$container.find(this.options.rowsContainer):this.$container;var r=this;this.$container.on("click",this.options.btAdd,function(e){e.preventDefault();var t=x(this).parents(r.options.repeatableElement);t.length||(t=null),r.addRow(t)}),this.$container.on("click",this.options.btRemove,function(e){e.preventDefault();var t=x(this).parents(r.options.repeatableElement);r.removeRow(t)}),this.options.btMove&&this.$containerRows.sortable({items:this.options.repeatableElement,handle:this.options.btMove,tolerance:"pointer"}),this.$container.trigger("subform-ready")},x.subformRepeatable.prototype.prepareTemplate=function(){if(this.options.rowTemplateSelector){var e=this.$container.find(this.options.rowTemplateSelector).last();this.template=x.trim(e.html())||"",this.$tmplElement=e}else{var t=this.$container.find(this.options.repeatableElement).get(0),r=x(t).clone();try{this.clearScripts(r)}catch(e){window.console&&console.log(e)}this.template=r.prop("outerHTML")}},x.subformRepeatable.prototype.addRow=function(e){var t=this.$containerRows.find(this.options.repeatableElement).length;if(t>=this.options.maximum)return null;var r=x.parseHTML(htmlspecialchar.decode(this.template));e?x(e).after(r):this.$containerRows.append(r);var a=x(r);a.attr("data-new","true"),this.fixUniqueAttributes(a,t);try{this.fixScripts(a)}catch(e){window.console&&console.log(e)}return this.$container.trigger("subform-row-add",a),a},x.subformRepeatable.prototype.removeRow=function(e){this.$containerRows.find(this.options.repeatableElement).length<=this.options.minimum||(this.$container.trigger("subform-row-remove",e),e.remove())},x.subformRepeatable.prototype.fixUniqueAttributes=function(e,t,r,a){var o=void 0===r?e.attr("data-group"):r,i=void 0===a?e.attr("data-base-name"):a,n=void 0===t?0:t,s=i+n;e.attr("data-group",s);for(var l=e.find("[name]"),p={},f=0,c=l.length;f<c;f++){var d=x(l[f]),u=d.attr("name"),h=u.replace(/(\[\]$)/g,"").replace(/(\]\[)/g,"__").replace(/\[/g,"_").replace(/\]/g,""),m=u.replace("["+o+"][","["+s+"]["),b=h.replace(o,s),v=0,w=h;"checkbox"===d.prop("type")&&u.match(/\[\]$/)?((v=p[h]?p[h].length:0)||(d.closest("fieldset.checkboxes").attr("id",b),e.find('label[for="'+h+'"]').attr("for",b).attr("id",b+"-lbl")),w+=v,b+=v):"radio"===d.prop("type")&&((v=p[h]?p[h].length:0)||(d.closest("fieldset.radio").attr("id",b),e.find('label[for="'+h+'"]').attr("for",b).attr("id",b+"-lbl")),w+=v,b+=v),p[h]?p[h].push(!0):p[h]=[!0],d.attr("name",m),d.attr("id",b),e.find('label[for="'+w+'"]').attr("for",b).attr("id",b+"-lbl")}for(var g=e.find(this.options.rowTemplateSelector),R=0;R<g.length;R++){var $=x(x(g[R]).prop("content"));this.fixUniqueAttributes($,n,o,i)}},x.subformRepeatable.prototype.clearScripts=function(e){x.fn.chosen&&e.find("select.chzn-done").each(function(){var e=x(this);e.next(".chzn-container").remove(),e.show().addClass("fix-chosen")})},x.subformRepeatable.prototype.fixScripts=function(e){e.find('a[onclick*="jInsertFieldValue"]').each(function(){var e=x(this),t=e.siblings('input[type="text"]').attr("id"),r=e.prev(),a=r.attr("href");e.attr("onclick","jInsertFieldValue('', '"+t+"');return false;"),r.attr("href",a.replace(/&fieldid=(.+)&/,"&fieldid="+t+"&"))}),x.fn.fieldMedia&&e.find(".field-media-wrapper").fieldMedia(),x.fn.fieldUser&&e.find(".field-user-wrapper").fieldUser(),window.SqueezeBox&&window.SqueezeBox.assign&&SqueezeBox.assign(e.find("a.modal").get(),{parse:"rel"}),e.find("div.subform-repeatable").subformRepeatable()},x.subformRepeatable.defaults={btAdd:".group-add",btRemove:".group-remove",btMove:".group-move",minimum:0,maximum:10,repeatableElement:".subform-repeatable-group",rowTemplateSelector:"template.subform-repeatable-template-section",rowsContainer:null},x.fn.subformRepeatable=function(e){return this.each(function(){var e=e||{},t=x(this).data();if(!t.subformRepeatable){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);var a=new x.subformRepeatable(this,e);x(this).data("subformRepeatable",a)}})},x(window).on("load",function(){x("div.subform-repeatable").subformRepeatable()}),window.htmlspecialchar={decode:function(e){var t={"&amp;":"&","&#038;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'","&#8217;":"’","&#8216;":"‘","&#8211;":"–","&#8212;":"—","&#8230;":"…","&#8221;":"”"};return e.replace(/\&[\w\d\#]{2,5}\;/g,function(e){return t[e]})}}}(jQuery);
